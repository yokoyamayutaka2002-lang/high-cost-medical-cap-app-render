<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>高額療養費シミュレータ</title>
  <style>
    body{font-family:system-ui, sans-serif; padding:20px; line-height:1.45; color:#222; font-size:16px; background:#fffaf2}
    .card{border:1px solid #e6ded6;padding:14px;border-radius:6px;margin:12px 0; background: #fffefb}
    .grid{display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #ddd;padding:8px;text-align:right}
    th{text-align:center;background:#f7f7f7}
    .muted{color:#666;font-size:0.9em}
    .highlight{background:#ffeeba}
    /* Responsive improvements */
    .table-responsive{overflow-x:auto;-webkit-overflow-scrolling:touch}
    table{min-width:760px}
    th,td{white-space:nowrap}
    /* Limit width of top-form selects/inputs so they don't span full page */
    fieldset.card select,
    fieldset.card input[type="date"],
    fieldset.card input[type="number"],
    fieldset.card textarea,
    #primary_drug_select,
    #lama_drug_select,
    #existing_old_select {
      display: inline-block;
      max-width: 520px;
      width: 100%;
      box-sizing: border-box;
    }
    #oral_drug_list { max-width: 520px; width:100%; box-sizing:border-box }

    /* Improve readability: increase spacing in form blocks and labels */
    fieldset.card { line-height:1.4; padding:14px; }
    label { display:block; margin-bottom:8px; }
    .card div { line-height:1.35 }
    .section-label { font-size:1.08em; font-weight:700; display:block; margin-bottom:8px; }

    /* Constrain result summary card widths so they form a compact grid */
    .grid .card { flex: 0 0 220px; max-width: 240px; }
    .grid .card div { text-align: left; }
    @media (min-width: 1200px) {
      fieldset.card select, fieldset.card input[type="date"], fieldset.card input[type="number"] { max-width: 480px; }
      #oral_drug_list { max-width: 480px }
    }
    @media (max-width: 1024px){
      .grid{flex-wrap:wrap}
      .card{flex:1 1 48%}
    }
    @media (max-width: 600px){
      body{padding:12px}
      th,td{padding:6px;font-size:0.95em}
      .card{flex:1 1 100%}
      table{min-width:640px}
    }
    /* Shorten specific form controls that only need small widths */
    /* Start date is just a date picker, keep it compact */
    #start_date { max-width: 180px; width: 180px; box-sizing: border-box; }
    /* qty2/qty3 are small integer inputs (1-3), keep compact */
    #qty2, #qty3 { max-width: 84px; width: 84px; box-sizing: border-box; }
    /* subsidy cap: show as shorter numeric input; label simplified below */
    #subsidy_cap { max-width: 160px; width: 160px; box-sizing: border-box; }
    /* Larger fonts for main section headings and actions */
    h1 { font-size: 1.5em; margin-bottom: 10px; }
    fieldset.card legend { font-size: 1.12em; font-weight: 600; }
    #existing_legend { font-size: 1.18em; font-weight:700; }
    /* Make submit button more prominent */
    button[type="submit"]{ font-size:1.05em; padding:10px 14px; }

    /* Prescription schedule: slightly larger fixed width so headers fit on one line
       Keep header cells from wrapping, allow body cells to wrap if needed. */
    /* Apply width constraint to any .card following an h3 (allow intervening elems) */
    h3 ~ .card { max-width: 840px; }
    h3 ~ .card .table-responsive { overflow-x: hidden; max-width: 100%; }
    h3 ~ .card .table-responsive table {
      min-width: 0;
      width: 100%;
      table-layout: auto; /* allow columns to size to content */
      border-collapse: collapse;
    }
    /* Header cells should not wrap so labels like "調整前金額（円）" remain on one line */
    h3 + .card .table-responsive table th { white-space: nowrap; }
    /* Body cells may wrap and show content; avoid aggressive truncation */
    h3 + .card .table-responsive table td {
      white-space: normal;
      word-break: normal;
      overflow: visible;
      padding: 6px 8px;
      font-size: 0.95em;
    }

    /* Results grid: arrange the six summary cards into 3 columns x 2 rows
       and limit the overall width to match the form/title area so it lines up.
       Center it horizontally. */
    .results-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      align-items: start;
      margin: 0 0 12px 0;
      max-width: 720px;
      width: 100%;
    }
    .results-grid .card { max-width: 100%; flex: none; }
    .results-grid .card strong { display:block; white-space: nowrap; }
    /* Responsive fallbacks */
    @media (max-width: 900px){
      .results-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px){
      .results-grid { grid-template-columns: 1fr; }
      .results-grid .card strong { white-space: normal; }
    }
    /* Warm pastel accents for result cards: green, yellow, red cycling */
    .results-grid .card:nth-child(3n+1){ background: #f7fff6; border-left:4px solid #bfecc6 }
    .results-grid .card:nth-child(3n+2){ background: #fffdf0; border-left:4px solid #ffe59a }
    .results-grid .card:nth-child(3n+3){ background: #fff6f6; border-left:4px solid #ffb6b6 }
    /* Slight shadow for cards to separate from background */
    .card{ box-shadow: 0 1px 0 rgba(0,0,0,0.04) }
    /* Table column width and diff-row highlighting (custom UI tweaks) */
    .cost-table th:first-child {
      width: 220px;
      min-width: 180px;
      max-width: 240px;
      white-space: nowrap;
      text-align: left;
    }
    /* 差額 → 薄いグレー（優先） */
    .cost-table .diff-row th,
    .cost-table .diff-row td {
      background-color: #f2f2f2;
      color: #333;
      font-weight: 700;
    }

    /* 医療費控除系 → 薄いピンク */
    .cost-table .deduction-row th,
    .cost-table .deduction-row td {
      background-color: #fdeaea;
      color: #8a2d2d;
    }

    /* 差額が優先されるように、diff-row と deduction-row が重複する場合は差額スタイルを適用 */
    .cost-table tr.diff-row.deduction-row th,
    .cost-table tr.diff-row.deduction-row td {
      background-color: #f2f2f2;
      color: #333;
      font-weight: 700;
    }

    /* ---------- Final override rules for the requested palette ---------- */
    /* 元の医療費（黄色） */
    .cost-table .base-row th,
    .cost-table .base-row td {
      background-color: #fff7cc;
    }

    /* 付加給付調整後（緑） */
    .cost-table .benefit-row th,
    .cost-table .benefit-row td {
      background-color: #e8f7ef;
      font-weight: 600;
    }

    /* 差額（グレー） - 再-declare to ensure precedence */
    .cost-table .diff-row th,
    .cost-table .diff-row td {
      background-color: #f2f2f2;
      color: #333;
      font-weight: 700;
    }

    /* 医療費控除・税・最終負担（ピンク） */
    .cost-table .deduction-row th,
    .cost-table .deduction-row td {
      background-color: #fdeaea;
      color: #8a2d2d;
    }

    /* 優先順位メモ（差額 > 控除 > 給付 > 元費用） - ensure rules above are applied in that order */
    /* Ensure result header isn't hidden behind fixed headers when scrolled to */
    #result-section { scroll-margin-top: 80px; }
  </style>
  
</head>
<body>
  <div class="screen-only">
  <h1 class="screen-only">高額療養費シミュレータ</h1>
  <form id="calc_form" class="screen-only" method="post" action="/calculate">
    <fieldset class="card">
      <legend>生物学的製剤</legend>
      <label>薬剤: <select id="drug_id" name="drug_id">
        {# Render all non-xolair entries first #}
        {% for d in drugs %}
          {% if not (d.drug_id and d.drug_id.startswith('xolair_')) %}
            <option value="{{ d.drug_id }}" {% if d.drug_id==selected_drug %}selected{% endif %}>{{ d.drug_id }} - {{ d.get('drug_name') or d.drug_id }}</option>
          {% endif %}
        {% endfor %}
        {# If any xolair_* entries exist, present a single unified 'xolair' choice. #}
        {% if has_xolair %}
          <option value="xolair" {% if selected_drug and ('xolair' in selected_drug) %}selected{% endif %}>xolair - ゾレア（IgE/体重で投与量が決まります）</option>
        {% endif %}
      </select></label>
      <div id="xolair_panel" style="display:none;margin-top:8px">
        <label>Xolair 用 IgE (IU/mL): <input id="xolair_ige" name="xolair_ige" type="number" min="0" step="1"/></label>
        <label style="margin-left:12px">体重 (kg): <input id="xolair_weight" name="xolair_weight" type="number" min="0" step="0.1"/></label>
        <div id="xolair_display" class="muted" style="margin-top:6px">Xolair: -</div>
      </div>
      <br>
      <label>開始日: <input id="start_date" type="date" name="start_date" value="{{ start_date or '' }}"/></label>
      <br>
      <label>{% if selected_drug and ('xolair' in selected_drug) %}2回目処方 回分:{% else %}2回目処方 本数:{% endif %} <input id="qty2" type="number" name="qty2" min="1" value="{{ qty2 or '' }}"/></label>
      <br>
      <label>{% if selected_drug and ('xolair' in selected_drug) %}3回目処方 回分:{% else %}3回目処方 本数:{% endif %} <input id="qty3" type="number" name="qty3" min="1" value="{{ qty3 or '' }}"/></label>
      <br>
      <!-- 投与間隔（週）: UIから削除しました -->
      <label>制度: 
        <select name="system_version" id="system_version">
          {% for sv in system_versions %}
          <option value="{{ sv }}" {% if sv==selected_system %}selected{% endif %}>{{ sv }}</option>
          {% endfor %}
        </select>
      </label>
      <br>
      <label>年齢区分:
        <select name="age_group" id="age_group">
          <option value="under70" {% if selected_age_group=='under70' %}selected{% endif %}>70歳未満</option>
          <option value="over70" {% if selected_age_group=='over70' %}selected{% endif %}>70歳以上</option>
        </select>
      </label>
      <br>
      <label>所得区分: 
        <select name="income_category" id="income_category_select">
          <!-- options populated by JS based on selected system and age_group -->
        </select>
      </label>
      <br>
      <label>自己負担割合: 
        <select name="burden_ratio">
          <option value="0.3" selected>30%</option>
          <option value="0.2">20%</option>
          <option value="0.1">10%</option>
        </select>
      </label>
      <br>
      <label><input type="checkbox" id="use_medical_deduction" name="use_medical_deduction" {% if request.form.get('use_medical_deduction') %}checked{% endif %}/> 医療費控除を利用</label>
      <div id="taxable_income_field" style="display:none;margin-top:6px">
        <label>課税所得（円）: <input id="taxable_income" name="taxable_income" type="number" min="0" step="1000" value="{{ request.form.get('taxable_income','') }}"/></label>
      </div>
      <br>
      <label style="display:inline-block"> <input type="checkbox" name="use_subsidy" id="use_subsidy" {% if request.form.get('use_subsidy') %}checked{% endif %}/> 付加給付制度を利用</label>
      <div id="subsidy_field" style="display:none; margin-top:6px">
        <label>月額（円）: <input type="number" name="subsidy_cap" id="subsidy_cap" value="{{ request.form.get('subsidy_cap') or '' }}" style="width:140px; box-sizing:border-box; margin-left:6px"/></label>
      </div>
    </fieldset>

    <fieldset class="card" id="prescription_steps_field">
      <legend>処方ステッププレビュー（Dupixent 用）</legend>
      <div id="prescription_steps">
        <div>1回目: <span id="step1_date" class="muted">-</span> <span id="step1_days" class="muted">-</span></div>
        <div>2回目: <span id="step2_date" class="muted">-</span> <span id="step2_days" class="muted">-</span></div>
        <div>3回目: <span id="step3_date" class="muted">-</span> <span id="step3_days" class="muted">-</span></div>
        <div>4回目: <span id="step4_date" class="muted">-</span> <span id="step4_days" class="muted">-</span></div>
        <div id="maintenance_note" class="muted" style="display:none">以降: 6本を84日ごとに投与</div>
      </div>
    </fieldset>

    <fieldset class="card">
      <legend id="existing_legend">既存治療</legend>
      <input type="hidden" name="existing_mode" value="csv" />

      <div style="margin-top:8px; text-align:left">
        {% if controllers and controllers|length > 0 %}
        <label class="section-label">吸入薬を選択</label>
        <select name="primary_drug_ids" id="primary_drug_select" multiple size="6" style="display:block; width:100%; margin-bottom:8px; text-align:left">
          <optgroup label="ICS/LABA/LAMA - 指定グループ">
            {% for d in controllers if d.group == 'TRIPLE' %}
              {% set label = d.display_name or d.drug_id %}
              <option value="{{ d.drug_id }}" data-class="{{ d.class|e }}" data-weekly="{{ d.weekly_price }}" {% if d.drug_id in (selected_primary_ids or []) %}selected{% endif %}>{{ label }}{% if d.strength %} {{ d.strength }}{% endif %}（週 {{ d.weekly_price }} 円）</option>
            {% endfor %}
          </optgroup>

          <optgroup label="ICS/LABA - それ以外（LAMA除く）">
            {% for d in controllers if d.group == 'ICS_LABA' %}
              {% set label = d.display_name or d.drug_id %}
              <option value="{{ d.drug_id }}" data-class="{{ d.class|e }}" data-weekly="{{ d.weekly_price }}" {% if d.drug_id in (selected_primary_ids or []) %}selected{% endif %}>{{ label }}{% if d.strength %} {{ d.strength }}{% endif %}（週 {{ d.weekly_price }} 円）</option>
            {% endfor %}
          </optgroup>
        </select>

        <label class="section-label">LAMAを選択</label>
        <select name="lama_drug_id" id="lama_drug_select" style="display:block; width:100%; margin-bottom:8px; text-align:left">
          <option value="">-- 選択しない --</option>
          {% for d in lamas %}
          <option value="{{ d.drug_id }}" data-class="{{ d.class|e }}" data-weekly="{{ d.weekly_price }}" {% if d.drug_id==selected_lama_id %}selected{% endif %}>{% if d.display_name %}{{ d.display_name }}{% else %}{{ d.drug_id }}{% endif %}{% if d.strength %} {{ d.strength }}{% endif %}（週 {{ d.weekly_price }} 円）</option>
          {% endfor %}
        </select>

        <label class="section-label">内服薬を選択</label>
        <div id="oral_drug_list" style="max-height:200px;overflow:auto;border:1px solid #eee;padding:6px; text-align:left">
          {% for o in oral_drugs %}
          <div style="margin-bottom:4px">
            <label style="white-space:nowrap"><input type="checkbox" name="oral_drug_ids" value="{{ o.drug_id }}" data-weekly="{{ o.weekly_price }}" {% if o.drug_id in (selected_oral_ids or []) %}checked{% endif %}/> {% if o.display_name %}{{ o.display_name }}{% else %}{{ o.drug_id }}{% endif %}{% if o.strength %} {{ o.strength }}{% endif %}（週 {{ o.weekly_price }} 円）</label>
          </div>
          {% endfor %}
        </div>
        <div class="muted">既存治療 合計週額: <span id="oral_weekly_sum">0</span> 円</div>
        <span id="lama_helper" class="muted" style="margin-left:8px;display:none">※Triple 選択時は LAMA を併用できません</span>
        {% else %}
          <label style="display:block; text-align:left">既存治療薬を選択（複数可）:
            <select name="existing_drug_ids" id="existing_old_select" multiple size="6" style="display:block; width:100%; text-align:left">
              {% for e in existing_drugs %}
              <option value="{{ e.drug_id }}" data-weekly="{{ e.weekly_cost_yen }}" {% if e.drug_id in (selected_existing_drug_ids or []) %}selected{% endif %}>{{ e.drug_name }}（週 {{ e.weekly_cost_yen }} 円）</option>
              {% endfor %}
            </select>
          </label>
        {% endif %}
      </div>
    </fieldset>

    <div style="margin-top:12px"><button type="submit">計算実行</button></div>
  </form>
  </div>

  {% if error_message %}
  <div class="card highlight"> <strong>エラー:</strong> {{ error_message }} </div>
  {% endif %}

  {% if results %}
  <h2 id="result-section">結果</h2>
  <div class="result-summary">
  <div class="calc-summary">
    <div class="condition-summary">
      <div class="cs-row">
        <div class="cs-item"><strong>開始日：</strong><span>{{ start_date or '—' }}</span></div>
        <div class="cs-item"><strong>制度：</strong><span>{{ system or selected_system or '' }}</span></div>
        <div class="cs-item"><strong>自己負担割合：</strong><span>{{ copay_rate_percent }}％</span></div>
      </div>
      <div class="cs-row">
        <div class="cs-item"><strong>年齢区分：</strong><span>{{ age_label or (age_group or selected_age_group) }}</span></div>
        <div class="cs-item"><strong>所得区分：</strong><span>{{ income_display or income_class or selected_income_category or '' }}</span></div>
      </div>
      <div class="cs-row">
        {% if medical_deduction_enabled %}
        <div class="cs-item"><strong>課税所得：</strong><span>{{ taxable_income }}円</span></div>
        {% else %}
        <div class="cs-item"><strong>課税所得：</strong><span>—</span></div>
        {% endif %}
        {% if benefit_enabled %}
        <div class="cs-item"><strong>付加給付制度：</strong><span>月額 {{ benefit_monthly or 0 }} 円</span></div>
        {% else %}
        <div class="cs-item"><strong>付加給付制度：</strong><span>—</span></div>
        {% endif %}
      </div>
    </div>
    {% if high_cost_applicable is defined %}
      {% if high_cost_applicable %}
        {#
        <div>
          <strong>高額療養費適用：</strong>
          <strong>可</strong>
        </div>
        #}
      {% else %}
        <div>
          <strong>高額療養費適用：</strong>
          <strong class="text-danger">不可</strong>
        </div>
      {% endif %}
    {% endif %}
  
  {% if selected_biologic or existing_treatments %}
  <hr>
  <div style="margin-top:12px">
    {# <strong>治療内容</strong> #}

    {% if selected_biologic %}
    <div style="margin-top:6px">
      <strong>生物学的製剤：</strong>
      <ul style="margin:6px 0 0 1em;padding-left:1.2em;list-style:disc">
        <li>{{ selected_biologic.display_name }}{% if selected_biologic.dose or selected_biologic.interval %}（{% if selected_biologic.dose %}{{ selected_biologic.dose }}{% endif %}{% if selected_biologic.dose and selected_biologic.interval %}・{% endif %}{% if selected_biologic.interval %}{{ selected_biologic.interval }}{% endif %}）{% endif %}</li>
      </ul>
    </div>
    {% endif %}

    {% if existing_treatments %}
    <div style="margin-top:6px">
      <strong>既存治療：</strong>
      <ul style="margin:6px 0 0 1em;padding-left:1.2em;list-style:disc">
        {% for drug in existing_treatments %}
          <li>
            {{ drug.display_name }}
            {% if drug.weekly_cost_yen is not none %}
              （週あたり {{ drug.weekly_cost_yen | yen }}）
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Compact two-year comparison table requested -->
  <div class="card" style="margin-bottom:12px">
    <div class="table-responsive">
      <table class="cost-table" style="width:100%; border-collapse:collapse;">
        <colgroup>
          <col style="width: 20%">
          <col style="width: 20%">
          <col style="width: 20%">
          <col style="width: 20%">
          <col style="width: 20%">
        </colgroup>
        <thead>
          <tr>
            <th style="text-align:left; background:#f7f7f7"></th>
            <th>2026年（年額）</th>
            <th>2026年（月額）</th>
            <th>2027年（年額）</th>
            <th>2027年（月額）</th>
          </tr>
        </thead>
        <tbody>
          <tr class="base-row"><th style="text-align:left">既存治療</th>
            <td>{{ (period_aggregates.calendar_start.existing_total_self_pay_annual | default(0)) | yen }}</td>
            <td>{{ ((period_aggregates.calendar_start.existing_total_self_pay_annual | default(0) / 12) | round(0) | int) | yen }}</td>
            <td>{{ (period_aggregates.calendar_next.existing_total_self_pay_annual | default(0)) | yen }}</td>
            <td>{{ ((period_aggregates.calendar_next.existing_total_self_pay_annual | default(0) / 12) | round(0) | int) | yen }}</td>
          </tr>
          <tr class="base-row"><th style="text-align:left">生物学的製剤</th>
            <td>{{ (period_aggregates.calendar_start.biologic_annual | default(0)) | yen }}</td>
            <td>{{ ((period_aggregates.calendar_start.biologic_annual | default(0) / 12) | round(0) | int) | yen }}</td>
            <td>{{ (period_aggregates.calendar_next.biologic_annual | default(0)) | yen }}</td>
            <td>{{ ((period_aggregates.calendar_next.biologic_annual | default(0) / 12) | round(0) | int) | yen }}</td>
          </tr>
          <tr class="diff-row"><th style="text-align:left">差額（生物学的製剤）</th>
            <td>{{ ((period_aggregates.calendar_start.biologic_annual | default(0)) - (period_aggregates.calendar_start.existing_total_self_pay_annual | default(0))) | yen }}</td>
            <td>{{ (((period_aggregates.calendar_start.biologic_annual | default(0)) - (period_aggregates.calendar_start.existing_total_self_pay_annual | default(0))) / 12) | round(0) | int | yen }}</td>
            <td>{{ ((period_aggregates.calendar_next.biologic_annual | default(0)) - (period_aggregates.calendar_next.existing_total_self_pay_annual | default(0))) | yen }}</td>
            <td>{{ (((period_aggregates.calendar_next.biologic_annual | default(0)) - (period_aggregates.calendar_next.existing_total_self_pay_annual | default(0))) / 12) | round(0) | int | yen }}</td>
          </tr>
          {% if benefit_enabled %}
          <tr class="benefit-row"><th style="text-align:left">付加給付あり</th>
            <td>{{ (period_aggregates.calendar_start.biologic_with_subsidy_annual | default(0)) | yen }}</td>
            <td>{{ ((period_aggregates.calendar_start.biologic_with_subsidy_annual | default(0) / 12) | round(0) | int) | yen }}</td>
            <td>{{ (period_aggregates.calendar_next.biologic_with_subsidy_annual | default(0)) | yen }}</td>
            <td>{{ ((period_aggregates.calendar_next.biologic_with_subsidy_annual | default(0) / 12) | round(0) | int) | yen }}</td>
          </tr>
          <tr class="diff-row"><th style="text-align:left">差額（付加給付）</th>
            <td>{{ ((period_aggregates.calendar_start.biologic_with_subsidy_annual | default(0)) - (period_aggregates.calendar_start.existing_total_self_pay_annual | default(0))) | yen }}</td>
            <td>{{ (((period_aggregates.calendar_start.biologic_with_subsidy_annual | default(0)) - (period_aggregates.calendar_start.existing_total_self_pay_annual | default(0))) / 12) | round(0) | int | yen }}</td>
            <td>{{ ((period_aggregates.calendar_next.biologic_with_subsidy_annual | default(0)) - (period_aggregates.calendar_next.existing_total_self_pay_annual | default(0))) | yen }}</td>
            <td>{{ (((period_aggregates.calendar_next.biologic_with_subsidy_annual | default(0)) - (period_aggregates.calendar_next.existing_total_self_pay_annual | default(0))) / 12) | round(0) | int | yen }}</td>
          </tr>
          {% endif %}
          {% if medical_deduction_enabled %}
          <tr class="group-deduction deduction-row"><th style="text-align:left">医療費控除還付</th>
            <td>{{ (period_aggregates.calendar_start.medical_tax_refund_total | default(0)) | yen }}</td>
            <td>{{ (period_aggregates.calendar_start.medical_tax_refund_total_monthly | default(0)) | yen }}</td>
            <td>{{ (period_aggregates.calendar_next.medical_tax_refund_total | default(0)) | yen }}</td>
            <td>{{ (period_aggregates.calendar_next.medical_tax_refund_total_monthly | default(0)) | yen }}</td>
          </tr>
          <tr class="group-deduction deduction-row"><th style="text-align:left; padding-left:2em">所得税</th>
            <td>{{ (period_aggregates.calendar_start.medical_tax_refund_income | default(0)) | yen }}</td>
            <td>{{ (period_aggregates.calendar_start.medical_tax_refund_income_monthly | default(0)) | yen }}</td>
            <td>{{ (period_aggregates.calendar_next.medical_tax_refund_income | default(0)) | yen }}</td>
            <td>{{ (period_aggregates.calendar_next.medical_tax_refund_income_monthly | default(0)) | yen }}</td>
          </tr>
          <tr class="group-deduction deduction-row"><th style="text-align:left; padding-left:2em">住民税</th>
            <td>{{ (period_aggregates.calendar_start.medical_tax_refund_resident | default(0)) | yen }}</td>
            <td>{{ (period_aggregates.calendar_start.medical_tax_refund_resident_monthly | default(0)) | yen }}</td>
            <td>{{ (period_aggregates.calendar_next.medical_tax_refund_resident | default(0)) | yen }}</td>
            <td>{{ (period_aggregates.calendar_next.medical_tax_refund_resident_monthly | default(0)) | yen }}</td>
          </tr>
          <tr class="group-final deduction-row"><th style="text-align:left">医療費控除還付後</th>
            <td>{{ (period_aggregates.calendar_start.after_medical_annual_self_pay | default(0)) | yen }}</td>
            <td>{{ (period_aggregates.calendar_start.after_medical_monthly_self_pay | default(0)) | yen }}</td>
            <td>{{ (period_aggregates.calendar_next.after_medical_annual_self_pay | default(0)) | yen }}</td>
            <td>{{ (period_aggregates.calendar_next.after_medical_monthly_self_pay | default(0)) | yen }}</td>
          </tr>
          <tr class="diff-row"><th style="text-align:left">差額（医療費控除）</th>
            <td>{{ (period_aggregates.calendar_start.difference_after_medical | default(0)) | yen }}</td>
            <td>{{ ((period_aggregates.calendar_start.difference_after_medical | default(0)) / 12) | round(0) | int | yen }}</td>
            <td>{{ (period_aggregates.calendar_next.difference_after_medical | default(0)) | yen }}</td>
            <td>{{ ((period_aggregates.calendar_next.difference_after_medical | default(0)) / 12) | round(0) | int | yen }}</td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
  {% if results %}
  {% endif %}
  </div> {# .result-summary end #}
  
  
  {# 月別内訳: UI上の表示は不要になったため省略 #}
  {% endif %}

  {% if prescription_schedule %}
  <div class="prescription-schedule">
  <h3 class="print-hide-title">処方スケジュール</h3>
  {% if xolair_display %}
  <div style="margin:6px 0 10px 0; font-weight:600">{{ xolair_display }}</div>
  {% endif %}
  <div class="card">
    <div class="table-responsive">
      <table>
      <thead>
        <tr>
          <th>回</th>
          <th>処方日</th>
          <th>{% if selected_drug and ('xolair' in selected_drug) %}処方単位{% else %}本数{% endif %}</th>
          <th>投与期間</th>
          <th>調整前金額</th>
          <th>自己負担金額</th>
          {% if benefit_enabled %}
          <th>付加給付調整後</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% set dpu = days_per_unit or 0 %}
        {% for ev in prescription_schedule %}
        {% set days = ev.get('days') if ev.get('days') is not none else (ev.qty * dpu) %}
        {% set weeks = (days // 7) if days else 0 %}
        <tr>
          <td style="text-align:center">{{ ev.order }}</td>
          <td style="text-align:left">{{ ev.date }}</td>
          <td style="text-align:center">{{ ev.qty }} {% if selected_drug and ('xolair' in selected_drug) %}回分{% else %}本{% endif %}</td>
          <td style="text-align:right">{{ days }}日 ({{ weeks }}週)</td>
          <td style="text-align:right">{% if ev.get('pre_adjust_amount') is not none %}¥{{ ev.get('pre_adjust_amount') }}{% else %}¥0{% endif %}</td>
          <td style="text-align:right">{% if ev.get('display_self_pay') is not none %}¥{{ ev.get('display_self_pay') }}{% else %}—{% endif %}</td>
          {% if benefit_enabled %}
          <td style="text-align:right">{% if ev.get('post_subsidy_self_pay') is not none %}¥{{ ev.get('post_subsidy_self_pay') }}{% else %}—{% endif %}</td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
      </table>
    </div>
  </div>
  </div>
  {% endif %}

<script>
function toggleMode(v){
  document.getElementById('csv_mode').style.display = v==='csv'? 'block':'none';
  document.getElementById('manual_mode').style.display = v==='manual'? 'block':'none';
}

// Dupixent step preview logic (client-side, immediate UX feedback)
function parseDate(s){
  if(!s) return null;
  const p = s.split('-');
  if(p.length!==3) return null;
  return new Date(Number(p[0]), Number(p[1])-1, Number(p[2]));
}
function formatDate(d){
  if(!d) return '-';
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}
function addDays(d, days){
  if(!d) return null;
  const nd = new Date(d.getTime());
  nd.setDate(nd.getDate() + Number(days));
  return nd;
}

function updateDupixentPreview(){
  const drug = (document.getElementById('drug_id')||{}).value || '';
  const k = (drug||'').toLowerCase();
  const isDup = k.indexOf('dupixent') !== -1 || k.indexOf('デュピクセント') !== -1;
  const startVal = document.getElementById('start_date').value;
  const qty2Val = Number(document.getElementById('qty2').value || 0);
  const qty3Val = Number(document.getElementById('qty3').value || 0);

  const step2El = document.getElementById('step2_date');
  const step3El = document.getElementById('step3_date');
  const step4El = document.getElementById('step4_date');
  const field = document.getElementById('prescription_steps_field');

  if(!isDup){
    // hide Dupixent preview for other drugs
    field.style.display = 'none';
    return;
  }
  field.style.display = 'block';
  const sd = parseDate(startVal);
  const s1DateEl = document.getElementById('step1_date');
  const s1DaysEl = document.getElementById('step1_days');
  const s2DaysEl = document.getElementById('step2_days');
  const s3DaysEl = document.getElementById('step3_days');
  const s4DaysEl = document.getElementById('step4_days');
  const maintenanceNote = document.getElementById('maintenance_note');

  if(!sd){
    s1DateEl.textContent = '-'; s1DaysEl.textContent='-';
    step2El.textContent='-'; s2DaysEl.textContent='-';
    step3El.textContent='-'; s3DaysEl.textContent='-';
    step4El.textContent='-'; s4DaysEl.textContent='-';
    maintenanceNote.style.display = 'none';
    return;
  }

  // 1回目: start, days fixed 14
  s1DateEl.textContent = formatDate(sd);
  s1DaysEl.textContent = '14日';

  // second = start + 14d
  const d2 = addDays(sd, 14);
  step2El.textContent = formatDate(d2);
  const d2_days = qty2Val > 0 ? qty2Val * 14 : '-';
  s2DaysEl.textContent = (d2_days === '-') ? '-' : (d2_days + '日');

  // third = second + (qty2 * 14d)
  if(qty2Val > 0){
    const d3 = addDays(d2, qty2Val * 14);
    step3El.textContent = formatDate(d3);
    const d3_days = qty3Val > 0 ? qty3Val * 14 : '-';
    s3DaysEl.textContent = (d3_days === '-') ? '-' : (d3_days + '日');
    // fourth = third + (qty3 * 14d)
    if(qty3Val > 0){
      const d4 = addDays(d3, qty3Val * 14);
      step4El.textContent = formatDate(d4);
      s4DaysEl.textContent = (6 * 14) + '日';
      maintenanceNote.style.display = 'block';
    } else {
      step4El.textContent = '-'; s4DaysEl.textContent = '-'; maintenanceNote.style.display = 'none';
    }
  } else {
    step3El.textContent = '-'; s3DaysEl.textContent='-';
    step4El.textContent = '-'; s4DaysEl.textContent='-'; maintenanceNote.style.display = 'none';
  }
}

function updateFasenraInputs(){
  const drug = (document.getElementById('drug_id')||{}).value || '';
  const k = (drug||'').toLowerCase();
  const isFasenra = k.indexOf('fasenra') !== -1 || k.indexOf('ファセンラ') !== -1;
  const qty2El = document.getElementById('qty2');
  const qty3El = document.getElementById('qty3');
  if(!qty2El || !qty3El) return;
  if(isFasenra){
    // For Fasenra, second and third prescription quantities are always 1.
    try{ qty2El.value = 1; }catch(e){}
    try{ qty3El.value = 1; }catch(e){}
    // Make inputs readonly so value is submitted but cannot be edited.
    qty2El.readOnly = true;
    qty3El.readOnly = true;
    // Also visually indicate disabled state
    qty2El.style.backgroundColor = '#f3f3f3';
    qty3El.style.backgroundColor = '#f3f3f3';
  } else {
    qty2El.readOnly = false;
    qty3El.readOnly = false;
    qty2El.style.backgroundColor = '';
    qty3El.style.backgroundColor = '';
  }
}

function updateExistingAggregationText(){
  const drug = (document.getElementById('drug_id')||{}).value || '';
  const k = (drug||'').toLowerCase();
  const isFasenra = k.indexOf('fasenra') !== -1 || k.indexOf('ファセンラ') !== -1;
  const legend = document.getElementById('existing_legend');
  const header = document.getElementById('existing_header_text');
  const muted = document.getElementById('existing_muted');
  // Always display the simplified legend text
  if(legend) legend.textContent = '既存治療';
  // Optionally update helper text for Fasenra, but keep legend consistent
  if(isFasenra){
    if(header) header.textContent = '既存治療（8週分）を合算します';
    if(muted) muted.textContent = '既存治療は 8 週分として合算されます';
  } else {
    if(header) header.textContent = '既存治療（12週分）を合算します';
    if(muted) muted.textContent = '既存治療は 12 週分として合算されます';
  }
}

function updateXolairUI(){
  const drug = (document.getElementById('drug_id')||{}).value || '';
  const k = (drug||'').toLowerCase();
  const isXolair = k === 'xolair' || k.indexOf('xolair') !== -1;
  const panel = document.getElementById('xolair_panel');
  const display = document.getElementById('xolair_display');
  const igeEl = document.getElementById('xolair_ige');
  const wtEl = document.getElementById('xolair_weight');
  if(!panel || !display || !igeEl || !wtEl) return;
  if(!isXolair){
    panel.style.display = 'none';
    display.textContent = 'Xolair: -';
    return;
  }
  panel.style.display = 'block';
  const ige = Number(igeEl.value || NaN);
  const wt = Number(wtEl.value || NaN);
  // Use embedded table (provided by server) to compute dose deterministically
  try{
    const T = window.XOLAIR_TABLE || [];
    let found = null;
    for(let i=0;i<T.length;i++){
      const r = T[i];
      // numeric comparisons: ige_min <= ige < ige_max and weight_min <= wt < weight_max
      if(!isNaN(ige) && !isNaN(wt)){
        if(Number(r.ige_min) <= ige && ige < Number(r.ige_max) && Number(r.weight_min) <= wt && wt < Number(r.weight_max)){
          found = r; break;
        }
      }
    }
    if(found){
      display.textContent = `Xolair: ${found.dose_mg} mg every ${found.interval_weeks} weeks`;
    } else {
      display.textContent = 'Xolair: No recommended dose for provided IgE/weight combination';
    }
  }catch(e){
    display.textContent = 'Xolair: -';
  }
}

document.addEventListener('DOMContentLoaded', function(){
  const els = ['start_date','qty2','qty3','drug_id'];
  els.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('change', function(e){ updateDupixentPreview(); updateFasenraInputs(); updateExistingAggregationText(); updateXolairUI(); });
    el.addEventListener('input', function(e){ updateDupixentPreview(); updateFasenraInputs(); updateExistingAggregationText(); updateXolairUI(); });
  });
  // initial run
  updateDupixentPreview();
  updateFasenraInputs();
  updateExistingAggregationText();
  updateXolairUI();
  // ensure existing_mode UI reflects server-provided selection
  try{ var existingModeEl = document.getElementById('existing_mode'); if(existingModeEl) toggleMode(existingModeEl.value); }catch(e){}
  try{
    var xige = document.getElementById('xolair_ige'); if(xige){ xige.addEventListener('input', updateXolairUI); xige.addEventListener('change', updateXolairUI); }
    var xwt = document.getElementById('xolair_weight'); if(xwt){ xwt.addEventListener('input', updateXolairUI); xwt.addEventListener('change', updateXolairUI); }
  }catch(e){}
});
</script>
<script>
// income_map is provided by server as JSON-compatible object
const INCOME_MAP = {{ income_map | tojson | safe }} || {};
// xolair table provided by server: list of rows with numeric fields
window.XOLAIR_TABLE = {{ xolair_table | tojson | safe }} || [];
document.addEventListener('DOMContentLoaded', function(){
  const systemEl = document.getElementById('system_version');
  const incomeSel = document.getElementById('income_category_select');
  const ageEl = document.getElementById('age_group');

  function rebuildIncomeOptions(sys, age){
    const list = (INCOME_MAP[sys] && INCOME_MAP[sys][age]) || [];
    // clear
    incomeSel.innerHTML = '';
    list.forEach(function(pair){
      const code = pair[0];
      const label = pair[1] || '';
      const opt = document.createElement('option');
      // send value as 'code|label' so server can display full label in summary
      opt.value = code + (label ? ('|' + label) : '');
      opt.text = label ? (code + ' （' + label + '）') : code;
      incomeSel.appendChild(opt);
    });
  }

  function onSelectionChange(){
    const sys = systemEl.value;
    const age = ageEl.value;
    rebuildIncomeOptions(sys, age);
  }

  if(systemEl){ systemEl.addEventListener('change', onSelectionChange); }
  if(ageEl){ ageEl.addEventListener('change', onSelectionChange); }
  // initial populate
  onSelectionChange();
  // restore selected income if server provided one
  const SELECTED_INCOME = '{{ selected_income_category or "" }}';
  if(SELECTED_INCOME){
    // small delay to ensure options populated
    setTimeout(function(){
      try{ incomeSel.value = SELECTED_INCOME; }catch(e){}
    }, 0);
  }
});
</script>
<script>
// Primary / Add-on logic: disable LAMA when primary is Triple
function onPrimaryChange(){
  const p = document.getElementById('primary_drug_select');
  const l = document.getElementById('lama_drug_select');
  const helper = document.getElementById('lama_helper');
  if(!p || !l) return;
  // when multiple primary options may be selected, disable LAMA if any selected is Triple
  let anyTriple = false;
  for(let i=0;i<p.options.length;i++){
    const opt = p.options[i];
    if(!opt.selected) continue;
    const cls = (opt.dataset && opt.dataset.class) ? (opt.dataset.class || '') : '';
    if(cls && cls.toLowerCase() === 'triple'){
      anyTriple = true; break;
    }
  }
  if(anyTriple){
    l.value = '';
    l.disabled = true;
    if(helper) helper.style.display = 'inline';
  } else {
    l.disabled = false;
    if(helper) helper.style.display = 'none';
  }
  try{ if(typeof updateOralSum === 'function') updateOralSum(); }catch(e){}
}
document.addEventListener('DOMContentLoaded', function(){
  const p = document.getElementById('primary_drug_select');
  if(p){ p.addEventListener('change', onPrimaryChange); }
  // initial run
  onPrimaryChange();
});
</script>
<script>
// Oral drugs preview: sum weekly prices from multi-select
function updateOralSum(){
  const els = document.querySelectorAll('input[name="oral_drug_ids"]');
  const el = document.getElementById('oral_weekly_sum');
  if(!els || !el) return;
  let sum = 0;
  els.forEach(function(cb){
    if(cb.checked){
      const w = Number(cb.dataset.weekly || 0);
      sum += isNaN(w) ? 0 : w;
    }
  });
  // include selected inhaled primary drugs
  try{
    const psel = document.getElementById('primary_drug_select');
    if(psel){
      for(let i=0;i<psel.options.length;i++){
        const opt = psel.options[i];
        if(opt.selected){ sum += Number(opt.dataset.weekly || 0) || 0; }
      }
    }
  }catch(e){}
  // include selected LAMA
  try{
    const lsel = document.getElementById('lama_drug_select');
    if(lsel && lsel.selectedIndex>=0){ const opt = lsel.options[lsel.selectedIndex]; sum += Number(opt.dataset.weekly || 0) || 0; }
  }catch(e){}
  // include legacy existing_old_select selections
  try{
    const eos = document.getElementById('existing_old_select');
    if(eos){ for(let i=0;i<eos.options.length;i++){ const o = eos.options[i]; if(o.selected){ sum += Number(o.dataset.weekly || 0) || 0; } } }
  }catch(e){}
  el.textContent = sum;
}
document.addEventListener('DOMContentLoaded', function(){
  const els = document.querySelectorAll('input[name="oral_drug_ids"]');
  els.forEach(function(cb){ cb.addEventListener('change', updateOralSum); });
  // watch inhaled selects too
  try{ const p = document.getElementById('primary_drug_select'); if(p) p.addEventListener('change', updateOralSum); }catch(e){}
  try{ const l = document.getElementById('lama_drug_select'); if(l) l.addEventListener('change', updateOralSum); }catch(e){}
  try{ const eos = document.getElementById('existing_old_select'); if(eos) eos.addEventListener('change', updateOralSum); }catch(e){}
  updateOralSum();
});
</script>

<!-- Ensure checkboxes reflect server-selected values (override browser state) -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  try{
    const selected = {{ (selected_oral_ids or []) | tojson }};
    const boxes = document.querySelectorAll('input[name="oral_drug_ids"]');
    boxes.forEach(function(cb){
      try{ cb.checked = Array.isArray(selected) && selected.indexOf(cb.value) !== -1; }catch(e){}
    });
    // refresh sum
    try{ if(typeof updateOralSum === 'function') updateOralSum(); }catch(e){}
  }catch(e){/* ignore */}
});
</script>
<script>
// Auto-fit select elements to the longest option text
function adjustSelectWidths(){
  // create a measuring span
  let meas = document.getElementById('__select_width_measure');
  if(!meas){
    meas = document.createElement('span');
    meas.id = '__select_width_measure';
    meas.style.position = 'absolute';
    meas.style.left = '-9999px';
    meas.style.top = '-9999px';
    meas.style.whiteSpace = 'nowrap';
    meas.style.visibility = 'hidden';
    document.body.appendChild(meas);
  }

  const selects = Array.from(document.querySelectorAll('select'));
  selects.forEach(function(sel){
    try{
      // Skip selects that explicitly opt-out
      if(sel.dataset && sel.dataset.noFit && sel.dataset.noFit === '1') return;

      let maxW = 0;
      for(let i=0;i<sel.options.length;i++){
        const opt = sel.options[i];
        // use option text as shown (trim)
        const txt = (opt.text || '').trim();
        if(!txt) continue;
        meas.textContent = txt;
        const w = meas.offsetWidth;
        if(w > maxW) maxW = w;
      }

      if(maxW <= 0) return;
      // add room for select padding + dropdown arrow
      const extra = sel.multiple || (sel.size && Number(sel.size) > 1) ? 60 : 48;
      let desired = maxW + extra;
      // clamp for very large values to keep layout sane
      const MIN = 140;
      const MAX = 520;
      if(desired < MIN) desired = MIN;
      if(desired > MAX) desired = MAX;
      sel.style.width = desired + 'px';
      sel.style.minWidth = MIN + 'px';
      sel.style.maxWidth = MAX + 'px';
    }catch(e){ /* ignore measurement errors */ }
  });
}

// run on load and when viewport changes
document.addEventListener('DOMContentLoaded', function(){
  try{ adjustSelectWidths(); }catch(e){}
  window.addEventListener('resize', function(){ try{ adjustSelectWidths(); }catch(e){} });
  // watch for option changes and re-run adjust
  try{
    const obs = new MutationObserver(function(){ adjustSelectWidths(); });
    document.querySelectorAll('select').forEach(function(s){ obs.observe(s, { childList:true, subtree:true }); });
  }catch(e){}
});
</script>
<script>
// Toggle visibility of taxable income field when medical deduction checkbox changes
document.addEventListener('DOMContentLoaded', function(){
  try{
    const cb = document.getElementById('use_medical_deduction');
    const field = document.getElementById('taxable_income_field');
    if(!cb || !field) return;
    function refresh(){
      try{
        if(cb.checked){ field.style.display = 'block'; }
        else { field.style.display = 'none'; }
      }catch(e){}
    }
    cb.addEventListener('change', refresh);
    // initial
    refresh();
  }catch(e){/* ignore */}
});
</script>

<script>
// Toggle visibility of subsidy input field when subsidy checkbox changes
document.addEventListener('DOMContentLoaded', function(){
  try{
    const sb = document.getElementById('use_subsidy');
    const sfield = document.getElementById('subsidy_field');
    if(!sb || !sfield) return;
    function refresh_sub(){
      try{
        if(sb.checked){ sfield.style.display = 'block'; }
        else { sfield.style.display = 'none'; }
      }catch(e){}
    }
    sb.addEventListener('change', refresh_sub);
    // initial
    refresh_sub();
  }catch(e){/* ignore */}
});
</script>
{% if results %}
<script>
  window.addEventListener('load', function () {
    const result = document.getElementById('result-section');
    if (result) {
      // Make element focusable for accessibility (if not already)
      if (!result.hasAttribute('tabindex')) result.setAttribute('tabindex', '-1');
      // Compute scroll target with an extra offset so the heading isn't flush
      // against the top of the viewport (prevents header overlap).
      const offset = 80; // px - adjust if your header height differs
      const y = result.getBoundingClientRect().top + window.pageYOffset - offset;
      window.scrollTo({ top: y, behavior: 'smooth' });
      // After scrolling, focus the heading so keyboard/screen-reader users land here
      setTimeout(function(){ try{ result.focus(); }catch(e){} }, 450);
    }
  });
</script>
{% endif %}
</head>
<body>
<script>
// Ensure system_version and income_category are sent: if empty, choose first option before submit.
document.addEventListener('DOMContentLoaded', function(){
  try{
    const form = document.getElementById('calc_form');
    const sys = document.getElementById('system_version');
    const income = document.getElementById('income_category_select');
    if(!form) return;
    form.addEventListener('submit', function(e){
      try{
        if(sys && (!sys.value || sys.value.length===0) && sys.options && sys.options.length>0){ sys.value = sys.options[0].value; }
        if(income && (!income.value || income.value.length===0) && income.options && income.options.length>0){ income.value = income.options[0].value; }
      }catch(err){ /* ignore */ }
    });
  }catch(e){/* ignore */}
});
</script>


<style>
@media print {
  @page {
    size: A4 portrait;
    margin: 10mm;
  }

  html, body {
    width: 210mm;
    height: 297mm;
    margin: 0 !important;
    padding: 0 !important;
    background: #fff !important;
    color: #000 !important;
  }

  body {
    font-size: 12px !important;
    line-height: 1.4 !important;
  }

  /* 画面操作系は非表示 */
  .screen-only, header, nav, .toolbar {
    display: none !important;
  }

  /* 結果タイトルは消す */
  h2#result-section {
    display: none !important;
  }

  /* 表は1ページ内に */
  table {
    width: 100% !important;
    border-collapse: collapse !important;
    page-break-inside: avoid !important;
    line-height: 1.4 !important;
  }

  th, td {
    padding: 5px 6px !important;
    font-size: 11px !important;
    line-height: 1.35 !important;
    vertical-align: middle !important;
  }

  thead {
    display: table-header-group !important;
  }

  tr {
    page-break-inside: avoid !important;
  }

  /* 処方スケジュールの「タイトルだけ」非表示 */
  .print-hide-title {
    display: none !important;
  }
}
</style>

</body>
</html>

